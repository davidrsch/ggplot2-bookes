<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Danielle Navarro, y Thomas Lin Pedersen">
<title>21&nbsp; Un caso de estudio – ggplot2: Gráficos elegantes para análisis de datos (3e)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./extensions.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6e4858b4921ffe5a9c7d897cee0e5447.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./extending.html">Temas avanzados</a></li><li class="breadcrumb-item"><a href="./ext-springs.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Un caso de estudio</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Buscar" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">ggplot2: Gráficos elegantes para análisis de datos (3e)</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/hadley/ggplot2-book/">
            Original
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/davidrsch/ggplot2-bookes">
            Traducción
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Alternar modo lector">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">¡Bienvenidos!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-3e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio a la tercera edición</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio a la segunda edición.</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./start.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Empezando</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting-started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Primeros pasos</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./toolbox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Layers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./individual-geoms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geomas individuales</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collective-geoms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geomas colectivas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-summaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resúmenes estadísticos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Redes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./annotations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Anotaciones</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arranging-plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Organizar gráficas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./scales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-position.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Escalas de posición y ejes.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-colour.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Escalas de colores y leyendas.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Otra estéticas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./mastery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">La Gramática</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Construya una gráfica capa por capa</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-guides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Escalas y guías</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coord.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Sistemas coordinados</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./facet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Facetado</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Temas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./extending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temas avanzados</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Programar con ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./internals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Internos de ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extendiendo ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ext-springs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Un caso de estudio</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
<li><a href="#sec-intuitive-spring" id="toc-sec-intuitive-spring" class="nav-link active" data-scroll-target="#sec-intuitive-spring"><span class="header-section-number">21.1</span> ¿Qué es un resorte?</a></li>
  <li>
<a href="#sec-spring-stat" id="toc-sec-spring-stat" class="nav-link" data-scroll-target="#sec-spring-stat"><span class="header-section-number">21.2</span> Parte 1: una estadística</a>
  <ul class="collapse">
<li><a href="#funcionalidad-del-edificio" id="toc-funcionalidad-del-edificio" class="nav-link" data-scroll-target="#funcionalidad-del-edificio"><span class="header-section-number">21.2.1</span> Funcionalidad del edificio</a></li>
  <li><a href="#creando-la-estad%C3%ADstica" id="toc-creando-la-estadística" class="nav-link" data-scroll-target="#creando-la-estad%C3%ADstica"><span class="header-section-number">21.2.2</span> Creando la estadística</a></li>
  <li><a href="#m%C3%A9todos" id="toc-métodos" class="nav-link" data-scroll-target="#m%C3%A9todos"><span class="header-section-number">21.2.3</span> Métodos</a></li>
  <li><a href="#constructores" id="toc-constructores" class="nav-link" data-scroll-target="#constructores"><span class="header-section-number">21.2.4</span> Constructores</a></li>
  <li><a href="#probando-la-estad%C3%ADstica" id="toc-probando-la-estadística" class="nav-link" data-scroll-target="#probando-la-estad%C3%ADstica"><span class="header-section-number">21.2.5</span> Probando la estadística</a></li>
  <li><a href="#post-mortem" id="toc-post-mortem" class="nav-link" data-scroll-target="#post-mortem"><span class="header-section-number">21.2.6</span> Post mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring2" id="toc-sec-spring2" class="nav-link" data-scroll-target="#sec-spring2"><span class="header-section-number">21.3</span> Part 2: Añadiendo estética</a>
  <ul class="collapse">
<li><a href="#post-mortem-1" id="toc-post-mortem-1" class="nav-link" data-scroll-target="#post-mortem-1"><span class="header-section-number">21.3.1</span> Post mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring3" id="toc-sec-spring3" class="nav-link" data-scroll-target="#sec-spring3"><span class="header-section-number">21.4</span> Parte 3: Una geoma</a>
  <ul class="collapse">
<li><a href="#extensiones-de-geom" id="toc-extensiones-de-geom" class="nav-link" data-scroll-target="#extensiones-de-geom"><span class="header-section-number">21.4.1</span> Extensiones de geom</a></li>
  <li><a href="#creando-la-geom" id="toc-creando-la-geom" class="nav-link" data-scroll-target="#creando-la-geom"><span class="header-section-number">21.4.2</span> Creando la geom</a></li>
  <li><a href="#un-constructor" id="toc-un-constructor" class="nav-link" data-scroll-target="#un-constructor"><span class="header-section-number">21.4.3</span> un constructor</a></li>
  <li><a href="#probando-la-geom" id="toc-probando-la-geom" class="nav-link" data-scroll-target="#probando-la-geom"><span class="header-section-number">21.4.4</span> Probando la geom</a></li>
  <li><a href="#post-mortem-2" id="toc-post-mortem-2" class="nav-link" data-scroll-target="#post-mortem-2"><span class="header-section-number">21.4.5</span> Post mortem</a></li>
  </ul>
</li>
  <li>
<a href="#una-introducci%C3%B3n-a-la-cuadr%C3%ADcula" id="toc-una-introducción-a-la-cuadrícula" class="nav-link" data-scroll-target="#una-introducci%C3%B3n-a-la-cuadr%C3%ADcula"><span class="header-section-number">21.5</span> Una introducción a la cuadrícula</a>
  <ul class="collapse">
<li><a href="#grobs" id="toc-grobs" class="nav-link" data-scroll-target="#grobs"><span class="header-section-number">21.5.1</span> Grobs</a></li>
  <li><a href="#ventanas-gr%C3%A1ficas" id="toc-ventanas-gráficas" class="nav-link" data-scroll-target="#ventanas-gr%C3%A1ficas"><span class="header-section-number">21.5.2</span> Ventanas gráficas</a></li>
  <li><a href="#par%C3%A1metros-gr%C3%A1ficos" id="toc-parámetros-gráficos" class="nav-link" data-scroll-target="#par%C3%A1metros-gr%C3%A1ficos"><span class="header-section-number">21.5.3</span> Parámetros gráficos</a></li>
  <li><a href="#unidades" id="toc-unidades" class="nav-link" data-scroll-target="#unidades"><span class="header-section-number">21.5.4</span> Unidades</a></li>
  <li><a href="#construyendo-clases-grob" id="toc-construyendo-clases-grob" class="nav-link" data-scroll-target="#construyendo-clases-grob"><span class="header-section-number">21.5.5</span> Construyendo clases grob</a></li>
  <li><a href="#sec-tabular-grid" id="toc-sec-tabular-grid" class="nav-link" data-scroll-target="#sec-tabular-grid"><span class="header-section-number">21.5.6</span> Cuadrícula tabular</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring4" id="toc-sec-spring4" class="nav-link" data-scroll-target="#sec-spring4"><span class="header-section-number">21.6</span> Parte 4: Un grid grob</a>
  <ul class="collapse">
<li><a href="#springgrob" id="toc-springgrob" class="nav-link" data-scroll-target="#springgrob"><span class="header-section-number">21.6.1</span> springGrob</a></li>
  <li><a href="#el-%C3%BAltimo-geomspring" id="toc-el-último-geomspring" class="nav-link" data-scroll-target="#el-%C3%BAltimo-geomspring"><span class="header-section-number">21.6.2</span> El último GeomSpring</a></li>
  <li><a href="#post-mortem-3" id="toc-post-mortem-3" class="nav-link" data-scroll-target="#post-mortem-3"><span class="header-section-number">21.6.3</span> Post mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring5" id="toc-sec-spring5" class="nav-link" data-scroll-target="#sec-spring5"><span class="header-section-number">21.7</span> Parte 5: Escalas</a>
  <ul class="collapse">
<li><a href="#escalada" id="toc-escalada" class="nav-link" data-scroll-target="#escalada"><span class="header-section-number">21.7.1</span> Escalada</a></li>
  <li><a href="#draw_key_spring" id="toc-draw_key_spring" class="nav-link" data-scroll-target="#draw_key_spring"><span class="header-section-number">21.7.2</span> draw_key_spring</a></li>
  <li><a href="#post-mortem-4" id="toc-post-mortem-4" class="nav-link" data-scroll-target="#post-mortem-4"><span class="header-section-number">21.7.3</span> Post mortem</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./extending.html">Temas avanzados</a></li><li class="breadcrumb-item"><a href="./ext-springs.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Un caso de estudio</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-spring1" class="quarto-section-identifier"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Un caso de estudio</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>You are reading the work-in-progress third edition of the ggplot2 book. This chapter should be readable but is currently undergoing final polishing.</p>
</div>
</div>
</div>
<p><a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a> proporcionó una descripción general de alto nivel sobre la creación de extensiones de ggplot2, basándose en la discusión sobre los aspectos internos de ggplot2 en <a href="internals.html" class="quarto-xref"><span>Capítulo 19</span></a>. En este capítulo llevaremos ese conocimiento un paso más allá, brindando una inmersión más profunda en el proceso de desarrollo de extensiones con todas las funciones. Para hacer esto, tomaremos un solo ejemplo (construir una nueva geom que parece un resorte) y lo seguiremos durante todo el proceso de desarrollo.</p>
<p>Este es un ejemplo cuidadosamente elaborado. Es poco probable que desee utilizar resortes para visualizar sus datos, por lo que ggplot2 aún no proporciona una geom de resorte. Sin embargo, los resortes son lo suficientemente complicados como para ilustrar las partes más importantes del proceso. ¡Esto los hace ideales para nuestros propósitos!</p>
<p>Desarrollaremos la ampliación en cinco fases:</p>
<ol type="1">
<li>Comenzaremos lo más simple posible usando el <code>geom_path()</code> existente, emparejándolo con una nueva estadística (<a href="#sec-spring-stat" class="quarto-xref"><span>Sección 21.2</span></a>).</li>
<li>La nueva estadística solo permite diámetro y tensión fijos, por lo que a continuación permitiremos que se utilicen por motivos estéticos (<a href="#sec-spring2" class="quarto-xref"><span>Sección 21.3</span></a>).</li>
<li>Una estadística es un excelente lugar para comenzar, pero tiene algunas restricciones fundamentales, por lo que a continuación convertiremos nuestro trabajo en una geom adecuada (<a href="#sec-spring3" class="quarto-xref"><span>Sección 21.4</span></a>).</li>
<li>Las geoms solo pueden usar dimensiones relativas a los datos y no pueden usar tamaños absolutos como 2 cm, por lo que a continuación te mostraremos cómo dibujar el resorte con una cuadrícula (<a href="#sec-spring4" class="quarto-xref"><span>Sección 21.6</span></a>).</li>
<li>Terminaremos proporcionando una escala personalizada y una leyenda para combinar con geom (<a href="#sec-spring5" class="quarto-xref"><span>Sección 21.7</span></a>).</li>
</ol>
<p>Una vez que haya recorrido este capítulo, le recomendamos encarecidamente que explore el código fuente de ggplot2 para ver cómo se implementan otras estadísticas y geoms. A menudo serán más complicados de lo que necesitas, pero te darán una idea de lo que puedes hacer.</p>
<section id="sec-intuitive-spring" class="level2" data-number="21.1"><h2 data-number="21.1" class="anchored" data-anchor-id="sec-intuitive-spring">
<span class="header-section-number">21.1</span> ¿Qué es un resorte?</h2>
<p>El desarrollo de una extensión generalmente comienza con una idea de lo que quieres dibujar. En este caso, queremos dibujar un resorte entre dos puntos, por lo que necesitamos algún código que dibuje un resorte que parezca plausible. Probablemente haya muchas formas de hacer esto, pero una sencilla es dibujar un círculo mientras se mueve el “bolígrafo” en una dirección. Aquí hay un conjunto de datos que define un círculo usando 100 puntos:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">circle</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  radians <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span>,</span>
<span>  index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"circle"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">circle</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="op">-</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Para transformar este círculo en un resorte que se extiende a lo largo del eje x usando dplyr, podríamos hacer algo como esto:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spring</span> <span class="op">&lt;-</span> <span class="va">circle</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    motion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="va">motion</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"spring"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">spring</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="op">-</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>En este caso, nuestro “resorte” sólo ha dado vueltas una vez, y no se parece mucho a un resorte real, pero si siguiéramos trazando el círculo mientras nos movemos a lo largo del eje x, terminaríamos con un resorte con múltiples bucles. Cuanto más rápido movamos el “bolígrafo”, más estiraremos el resorte. Esto nos da una idea de los dos parámetros que caracterizan nuestros resortes:</p>
<ul>
<li>El <code>diameter</code> del resorte, definido por el tamaño del círculo.</li>
<li>La <code>tension</code> del resorte, definida por la rapidez con la que nos movemos a lo largo de <code>x</code>.</li>
</ul>
<p>Aunque probablemente esta no sea una parametrización físicamente correcta de los resortes en el mundo real, es lo suficientemente buena para nuestros propósitos.</p>
<p>Ahora que tenemos un método para dibujar resortes, vale la pena dedicar un poco de tiempo a pensar en lo que requerirá una geom basada en este método. El código que hemos escrito hasta este punto está perfectamente bien para un solo gráfico, pero hay nuevas preguntas a considerar al crear una extensión:</p>
<ul>
<li>¿Cómo especificaremos el diámetro de un resorte?</li>
<li>¿Cómo mantenemos los círculos circulares incluso cuando cambiamos la relación de aspecto de la gráfica?</li>
<li>¿Podemos asignar diámetro y tensión a variables en los datos?</li>
<li>¿El diámetro y la tensión deberían ser parámetros que deben ser los mismos para todos los resortes en una capa o deberían ser una estética escalada que pueda variar de un resorte a otro?</li>
<li>Si planeamos distribuir nuestro spring geom a otros usuarios de R, ¿queremos depender del paquete dplyr?</li>
</ul>
<p>Consideraremos estas preguntas a medida que avancemos en el capítulo.</p>
</section><section id="sec-spring-stat" class="level2" data-number="21.2"><h2 data-number="21.2" class="anchored" data-anchor-id="sec-spring-stat">
<span class="header-section-number">21.2</span> Parte 1: una estadística</h2>
<p>Comencemos a convertir esta idea en una extensión de ggplot2. Debido a que estamos creando una extensión que dibuja una nueva capa ggplot2, debemos decidir si el objeto ggproto que creamos debe ser <code>Stat</code> o <code>Geom</code>. Quizás sea sorprendente que esta decisión no esté guiada por si queremos terminar con <code>geom_spring()</code> o <code>stat_spring()</code>: hay muchas extensiones <code>Stat</code> que se usan a través de un constructor <code>geom_*()</code> . Una mejor manera de pensar en esta decisión es considerar si podemos usar una geom existente con datos transformados. En ese caso, podemos usar una <code>Stat</code> que suele ser más sencilla de codificar que una <code>Geom</code>.</p>
<p>El código que escribimos en la última sección se ajusta muy bien a esta descripción. Lo único que hacemos es dibujar un camino, pero damos vueltas en lugar de ir en línea recta. Eso sugiere que podemos usar una <code>Stat</code> que transforma los datos y luego usa <code>GeomPath</code> para encargarse del dibujo real.</p>
<section id="funcionalidad-del-edificio" class="level3" data-number="21.2.1"><h3 data-number="21.2.1" class="anchored" data-anchor-id="funcionalidad-del-edificio">
<span class="header-section-number">21.2.1</span> Funcionalidad del edificio</h3>
<p>Siempre que esté desarrollando una nueva <code>Stat</code>, una estrategia sensata es comenzar escribiendo la función de transformación de datos y luego, una vez que esté funcionando, incorporarla a un ggproto <code>Stat</code>. En este caso, vamos a necesitar una función <code>create_spring()</code> que tome un punto inicial, un punto final, un diámetro y una tensión. Más precisamente:</p>
<ul>
<li>Nuestro punto de partida estará definido por los argumentos <code>x</code> e <code>y</code>.</li>
<li>Nuestro punto final estará definido por los argumentos <code>xend</code> y <code>yend</code>.</li>
<li>El argumento <code>diameter</code> se utilizará para escalar el tamaño de nuestro círculo.</li>
<li>Definir <code>tension</code> es un poco más complicado. La cantidad que realmente queremos expresar es “qué tan lejos se mueve el resorte en relación con el tamaño de los círculos”. Entonces definiremos <code>tension</code> para referirnos a la distancia total movida desde el punto inicial hasta el punto final, dividida por el tamaño de los círculos.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>
</li>
<li>También tendremos un parámetro <code>n</code> para dar el número de puntos utilizados por revolución, definiendo la fidelidad visual del resorte.</li>
</ul>
<p>Ahora podemos escribir código para nuestra función <code>create_spring()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">create_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                          <span class="va">y</span>, </span>
<span>                          <span class="va">xend</span>, </span>
<span>                          <span class="va">yend</span>, </span>
<span>                          <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                          <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                          <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Validar los argumentos de entrada.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">tension</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`tension` debe ser mayor que cero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">diameter</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`diameter` no puede ser cero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`n` debe ser mayor que cero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Calcule la longitud directa de la trayectoria del resorte</span></span>
<span>  <span class="va">length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xend</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">yend</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calcular el número de revoluciones y puntos que necesitamos</span></span>
<span>  <span class="va">n_revolutions</span> <span class="op">&lt;-</span> <span class="va">length</span> <span class="op">/</span> <span class="op">(</span><span class="va">diameter</span> <span class="op">*</span> <span class="va">tension</span><span class="op">)</span></span>
<span>  <span class="va">n_points</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">*</span> <span class="va">n_revolutions</span></span>
<span>  </span>
<span>  <span class="co"># Calcule la secuencia de radianes y los valores de compensación de x e y</span></span>
<span>  <span class="va">radians</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_revolutions</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">xend</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">yend</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Crear y devolver el marco de datos transformado.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span> <span class="op">*</span> <span class="va">diameter</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span> <span class="op">*</span> <span class="va">diameter</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta función conserva la lógica del código Spring que escribimos en <a href="#sec-intuitive-spring" class="quarto-xref"><span>Sección 21.1</span></a>, pero hace algunas cosas nuevas que son muy importantes al escribir extensiones:</p>
<ul>
<li>Es preciso al especificar los parámetros que definen el resorte.</li>
<li>Comprueba explícitamente la entrada y utiliza <code><a href="https://rlang.r-lib.org/reference/abort.html">rlang::abort()</a></code> para generar un error si el usuario pasa un valor no válido a la función.</li>
<li>Utiliza funciones base R para hacer el trabajo: no hay código dplyr en esta función porque no queremos que nuestra <code>Stat</code> dependa de dplyr.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>
</li>
</ul>
<p>Lo bueno de escribir <code>create_spring()</code> como función es que podemos probarla<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> para convencernos de que la lógica funciona:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spring</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">4</span>, y <span class="op">=</span> <span class="fl">2</span>, xend <span class="op">=</span> <span class="fl">10</span>, yend <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fl">2</span>, tension <span class="op">=</span> <span class="fl">0.6</span>, n <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">spring</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="creando-la-estadística" class="level3" data-number="21.2.2"><h3 data-number="21.2.2" class="anchored" data-anchor-id="creando-la-estadística">
<span class="header-section-number">21.2.2</span> Creando la estadística</h3>
<p>Ahora que tenemos nuestra función de transformación, nuestra siguiente tarea es encapsularla en una <code>Stat</code>. Para hacer esto, tomaremos lo que aprendimos sobre la creación de objetos <code>Stat</code> en <a href="extensions.html#sec-new-stats" class="quarto-xref"><span>Sección 20.2</span></a> y lo ampliaremos un poco. Nuestro primer paso es escribir un código que cree una subclase de <code>Stat</code> a la que llamaremos <code>StatSpring</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esto crea una nueva subclase <code>Stat</code> llamada <code>StatSpring</code>. Esta clase no hace nada interesante en este momento: lo único que hace este código hasta ahora es darle un nombre a la clase.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Para que esto sea útil, necesitaremos especificar los métodos que incorporar la funcionalidad que deseamos. En <a href="extensions.html#sec-new-stats" class="quarto-xref"><span>Sección 20.2</span></a> creamos una <code>Stat</code> anulando el método predeterminado <code>compute_group()</code> y el campo predeterminado para <code>required_aes</code>,<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> pero los objetos <code>Stat</code> tienen muchas propiedades que puedes modificar. Si imprimimos el objeto <code>Stat</code>, podemos ver una lista de esas propiedades:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Stat</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class Stat, gg&gt;</span></span>
<span><span class="co">#&gt;     aesthetics: function</span></span>
<span><span class="co">#&gt;     compute_group: function</span></span>
<span><span class="co">#&gt;     compute_layer: function</span></span>
<span><span class="co">#&gt;     compute_panel: function</span></span>
<span><span class="co">#&gt;     default_aes: uneval</span></span>
<span><span class="co">#&gt;     dropped_aes: </span></span>
<span><span class="co">#&gt;     extra_params: na.rm</span></span>
<span><span class="co">#&gt;     finish_layer: function</span></span>
<span><span class="co">#&gt;     non_missing_aes: </span></span>
<span><span class="co">#&gt;     optional_aes: </span></span>
<span><span class="co">#&gt;     parameters: function</span></span>
<span><span class="co">#&gt;     required_aes: </span></span>
<span><span class="co">#&gt;     retransform: TRUE</span></span>
<span><span class="co">#&gt;     setup_data: function</span></span>
<span><span class="co">#&gt;     setup_params: function</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Puedes modificar casi cualquiera de estos: los únicos que no debes tocar son <code>aesthetics</code> y <code>parameters</code>, que están destinados únicamente para uso interno.</p>
<p>Para nuestro ejemplo de <code>StatSpring</code>, los tres métodos/campos que necesitaremos especificar son <code>setup_data()</code>, <code>compute_panel()</code> y <code>required_aes</code>. Analizaremos esto con más detalle en la siguiente sección, pero para ayudarlo a ver a qué apuntamos, aquí está el código completo de nuestra estadística:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span>, </span>
<span>  </span>
<span>  <span class="co"># Edite los datos de entrada para garantizar que los identificadores de grupo sean únicos</span></span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Construya datos para este panel llamando a create_spring()</span></span>
<span>  compute_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                           <span class="va">scales</span>, </span>
<span>                           <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                           <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                           <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>          tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>          n <span class="op">=</span> <span class="va">n</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Especificar qué estética se requiere entrada</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>WPodemos imprimir cualquiera de estos métodos con un comando como <code>StatSpring$compute_panel</code> o <code>StatSpring$setup_data</code>.</p>
</section><section id="métodos" class="level3" data-number="21.2.3"><h3 data-number="21.2.3" class="anchored" data-anchor-id="métodos">
<span class="header-section-number">21.2.3</span> Métodos</h3>
<p>Echemos un vistazo más de cerca a los métodos definidos para nuestro <code>StatSpring</code>. Como se analiza en <a href="extensions.html#sec-new-stats" class="quarto-xref"><span>Sección 20.2</span></a>, los métodos más importantes para una estadística son los tres métodos <code>compute_*</code>. Siempre se debe definir uno de estos, generalmente <code>compute_group()</code> o <code>compute_panel()</code>. Como regla general, si la estadística opera en varias filas, comenzamos implementando un método <code>compute_group()</code>, y si la estadística opera en filas individuales, implementamos un método <code>compute_panel()</code>. Nuestra estadística de resorte es del último tipo: cada resorte está definido por una sola fila de datos originales, por lo que usaremos el método <code>compute_panel()</code> que recibe todos los datos de un solo panel.</p>
<p>Como puedes ver al mirar el código fuente de nuestro método <code>compute_panel()</code>, estamos haciendo un poco más que simplemente llamar a nuestra función <code>create_spring()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">scales</span>, <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>        tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>        n <span class="op">=</span> <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Usamos <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> para recorrer cada fila de datos y crear los puntos necesarios para dibujar el resorte correspondiente. Para cada uno de estos resortes, usamos <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code> para combinar los datos del resorte con todas las columnas que no son de posición de la fila de entrada. Esto es muy importante, ya que de lo contrario las asignaciones estéticas a p.e. El color y el tamaño se perderían. Finalmente, debido a que la salida de <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> es una lista de marcos de datos (uno por primavera), usamos <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> para combinarlos en un único marco de datos que se devuelve.</p>
<p>Al definir una nueva estadística, es muy común especificar uno o ambos métodos <code>setup_data()</code> y <code>setup_params()</code>. Estos métodos se invocan al principio del proceso de construcción de la gráfica, por lo que puede utilizarlos para realizar comprobaciones y modificaciones tempranas de los parámetros y datos.</p>
<p>Para nuestro ejemplo <code>StatSpring</code>, utilizamos el método <code>setup_data()</code> para garantizar que cada fila de entrada tenga una estética de grupo única. Esto es importante porque vamos a dibujar nuestros resortes con <code>GeomPath</code> y debemos asegurarnos de que el marco de datos generado por la estadística tenga un identificador único para cada resorte. Al hacerlo, se garantiza que la geom dibuje cada resorte como un camino distinto y no dibuje ninguna línea de conexión entre diferentes resortes. Nuevamente, hay algunos detalles sutiles sobre los que llamar la atención en la implementación:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tenga en cuenta que esta implementación conserva el valor original de <code>data$group</code> y agrega una identificación única si es necesario. Esto es importante porque la estética del grupo a veces se utiliza para transportar metadatos y no queremos perder esa información.</p>
<p>La parte final de nuestra nueva clase es el campo <code>required_aes</code>. Este es un vector de caracteres que proporciona los nombres de la estética que el usuario <em>debe</em> proporcionar a la estadística. En este caso, debemos asegurarnos de que el usuario especifique cuatro posiciones estéticas: x e y definen dónde comienza el resorte, mientras que xend y yend definen dónde termina. El campo <code>required_aes</code>, junto con <code>default_aes</code> y <code>non_missing_aes</code>, también define la estética que comprende esta estadística. Cualquier estética que no aparezca en estos campos (o en los campos del geom correspondiente) generará una advertencia y el mapeo será ignorado.</p>
</section><section id="constructores" class="level3" data-number="21.2.4"><h3 data-number="21.2.4" class="anchored" data-anchor-id="constructores">
<span class="header-section-number">21.2.4</span> Constructores</h3>
<p>Ahora que tenemos nuestro objeto ggproto <code>StatSpring</code>, es hora de escribir funciones constructoras con las que el usuario interactuará. Estrictamente hablando, no necesitamos hacer esto, porque <code>geom_path(stat = "spring")</code> ya funcionará, pero es una buena práctica escribir funciones constructoras para comodidad de los usuarios. Además, la función constructora proporciona un buen lugar para documentar la nueva funcionalidad.</p>
<p>Quizás sea sorprendente que los objetos de estadísticas casi siempre estén emparejados con un constructor <code>geom_*()</code> porque la mayoría de los usuarios de ggplot2 están acostumbrados a agregar geoms, no estadísticas, cuando construyen una gráfica. El constructor en sí es principalmente código repetitivo que envuelve una llamada a <code>layer()</code>; solo tenga cuidado de hacer coincidir el orden de los argumentos y los nombres utilizados en los constructores de ggplot2 para no sorprender a sus usuarios.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"spring"</span>,</span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                        <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>,</span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                        <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>,</span>
<span>    geom <span class="op">=</span> <span class="va">GeomPath</span>,</span>
<span>    position <span class="op">=</span> <span class="va">position</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      diameter <span class="op">=</span> <span class="va">diameter</span>,</span>
<span>      tension <span class="op">=</span> <span class="va">tension</span>,</span>
<span>      n <span class="op">=</span> <span class="va">n</span>,</span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>,</span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>,</span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>,</span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para que esté completo, también debes crear una función constructora <code>stat_*()</code>. No hay sorpresas aquí: <code>stat_spring()</code> es muy similar a <code>geom_spring()</code> excepto que proporciona una geom predeterminada en lugar de una estadística predeterminada.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stat_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">geom</span> <span class="op">=</span> <span class="st">"path"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                        <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">StatSpring</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">geom</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>      tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="probando-la-estadística" class="level3" data-number="21.2.5"><h3 data-number="21.2.5" class="anchored" data-anchor-id="probando-la-estadística">
<span class="header-section-number">21.2.5</span> Probando la estadística</h3>
<p>Ahora que todo está en su lugar, podemos probar nuestra nueva capa:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  yend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">5</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Esto se ve bastante bien. Los usuarios pueden llamar a nuestra función constructora <code>geom_spring()</code> y obtener resultados sensatos. Mejor aún, debido a que hemos escrito una nueva estadística, obtenemos una serie de funciones de forma gratuita, como escalado y facetado:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span>, colour <span class="op">=</span> <span class="va">class</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">class</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>Los usuarios también tienen la opción de llamar al constructor <code>stat_spring()</code>, lo que puede ser útil si por alguna razón quieren dibujar los resortes con puntos en lugar de rutas:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">stat_spring</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span>, colour <span class="op">=</span> <span class="va">class</span><span class="op">)</span>,</span>
<span>    geom <span class="op">=</span> <span class="st">"point"</span>, </span>
<span>    n <span class="op">=</span> <span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">class</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section><section id="post-mortem" class="level3" data-number="21.2.6"><h3 data-number="21.2.6" class="anchored" data-anchor-id="post-mortem">
<span class="header-section-number">21.2.6</span> Post mortem</h3>
<p>Ahora hemos creado con éxito nuestra primera extensión. Funciona, pero tiene algunas limitaciones en las que ahora debemos pensar.</p>
<p>Una desventaja de nuestra implementación es que el diámetro y la tensión son constantes que sólo se pueden establecer para la capa completa. Estas configuraciones se parecen más a la estética y sería bueno si sus valores pudieran asignarse a una variable en los datos. Discutiremos soluciones a este problema en <a href="#sec-spring2" class="quarto-xref"><span>Sección 21.3</span></a> y <a href="#sec-spring3" class="quarto-xref"><span>Sección 21.4</span></a>.</p>
</section></section><section id="sec-spring2" class="level2" data-number="21.3"><h2 data-number="21.3" class="anchored" data-anchor-id="sec-spring2">
<span class="header-section-number">21.3</span> Part 2: Añadiendo estética</h2>
<p>La estadística que creamos en la última sección trata el <code>diameter</code> y la <code>tension</code> como argumentos constantes: no son estéticos y el usuario no puede asignarlos a una variable en los datos. Podemos solucionar este problema realizando algunos pequeños cambios en el código <code>StatSpring</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span>,</span>
<span>                      </span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  compute_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">scales</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  optional_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diameter"</span>, <span class="st">"tension"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La principal diferencia con nuestro intento anterior es que los argumentos <code>diameter</code> y <code>tension</code> de <code>compute_panel()</code> han desaparecido y ahora se toman de los datos (al igual que <code>x</code>, <code>y</code>, etc.) . Esto tiene un inconveniente que solucionaremos en <a href="#sec-spring3" class="quarto-xref"><span>Sección 21.4</span></a>: ya no podemos establecer una estética fija. Debido a esto, necesitaremos eliminar esos argumentos de la función constructora:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"spring"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomPath</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El constructor <code>stat_spring()</code> requeriría el mismo tipo de cambio.</p>
<p>Todo lo que queda es probar nuestra nueva implementación:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  yend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">5</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  tension <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tension <span class="op">=</span> <span class="va">tension</span>, diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Parece funcionar. Sin embargo, como esperábamos, ya no es posible establecer <code>diameter</code> y <code>tension</code> como parámetros:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span>diameter <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in geom_spring(diameter = 0.5): Ignoring unknown parameters: `diameter`</span></span>
<span><span class="co">#&gt; Warning: Computation failed in `stat_spring()`.</span></span>
<span><span class="co">#&gt; Caused by error in `if (tension &lt;= 0) ...`:</span></span>
<span><span class="co">#&gt; ! argument is of length zero</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<section id="post-mortem-1" class="level3" data-number="21.3.1"><h3 data-number="21.3.1" class="anchored" data-anchor-id="post-mortem-1">
<span class="header-section-number">21.3.1</span> Post mortem</h3>
<p>En esta sección desarrollamos aún más nuestra estadística de resortes para que el <code>diameter</code> y la <code>tension</code> puedan usarse como estética, variando entre resortes. Desafortunadamente, existe un gran inconveniente: estas funciones ya no se pueden configurar globalmente. También nos falta una forma de controlar la escala de las dos estéticas. Solucionar ambos problemas requiere el mismo siguiente paso: alejar nuestra implementación de <code>Stat</code> y acercarla a una adecuada <code>Geom</code>.</p>
</section></section><section id="sec-spring3" class="level2" data-number="21.4"><h2 data-number="21.4" class="anchored" data-anchor-id="sec-spring3">
<span class="header-section-number">21.4</span> Parte 3: Una geoma</h2>
<p>En muchos casos, un enfoque centrado en las estadísticas es suficiente; por ejemplo, muchas de las primitivas gráficas proporcionadas por el paquete <a href="https://ggforce.data-imaginist.com">ggforce</a> son estadísticas. Pero necesitamos ir más allá con la geom del resorte porque la estética de la <code>tension</code> y el <code>diameter</code> deben especificarse en unidades que no están relacionadas con el sistema de coordenadas. En consecuencia, reescribiremos nuestra geom para que sea una extensión <code>Geom</code> adecuada.</p>
<section id="extensiones-de-geom" class="level3" data-number="21.4.1"><h3 data-number="21.4.1" class="anchored" data-anchor-id="extensiones-de-geom">
<span class="header-section-number">21.4.1</span> Extensiones de geom</h3>
<p>Como se analizó en <a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a>, existen muchas similitudes entre las extensiones <code>Stat</code> y <code>Geom</code>. La mayor diferencia es que las extensiones <code>Stat</code> devuelven una versión modificada de los datos de entrada, mientras que las extensiones <code>Geom</code> devuelven objetos gráficos. En algunos casos, crear una nueva geom requiere que uses el paquete grid (cubriremos esto en <a href="#sec-spring4" class="quarto-xref"><span>Sección 21.6</span></a>), pero a menudo no es necesario.</p>
<p>Al igual que los objetos de estadísticas, los objetos geom en ggproto tienen varios métodos y campos que puedes modificar. Puedes ver la lista imprimiendo el objeto:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Geom</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class Geom, gg&gt;</span></span>
<span><span class="co">#&gt;     aesthetics: function</span></span>
<span><span class="co">#&gt;     default_aes: uneval</span></span>
<span><span class="co">#&gt;     draw_group: function</span></span>
<span><span class="co">#&gt;     draw_key: function</span></span>
<span><span class="co">#&gt;     draw_layer: function</span></span>
<span><span class="co">#&gt;     draw_panel: function</span></span>
<span><span class="co">#&gt;     extra_params: na.rm</span></span>
<span><span class="co">#&gt;     handle_na: function</span></span>
<span><span class="co">#&gt;     non_missing_aes: </span></span>
<span><span class="co">#&gt;     optional_aes: </span></span>
<span><span class="co">#&gt;     parameters: function</span></span>
<span><span class="co">#&gt;     rename_size: FALSE</span></span>
<span><span class="co">#&gt;     required_aes: </span></span>
<span><span class="co">#&gt;     setup_data: function</span></span>
<span><span class="co">#&gt;     setup_params: function</span></span>
<span><span class="co">#&gt;     use_defaults: function</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="creando-la-geom" class="level3" data-number="21.4.2"><h3 data-number="21.4.2" class="anchored" data-anchor-id="creando-la-geom">
<span class="header-section-number">21.4.2</span> Creando la geom</h3>
<p>De la misma manera que una estadística usa los métodos <code>compute_layer()</code>, <code>compute_panel()</code> y <code>compute_group()</code> para transformar los datos, una geom usa <code>draw_layer()</code>, <code>draw_panel()</code> y <code>draw_group()</code> para crear representaciones gráficas de los datos. De la misma manera que creamos <code>StatSpring</code> escribiendo un método <code>compute_panel()</code> para hacer el trabajo pesado, crearemos <code>GeomSpring</code> escribiendo un método <code>draw_panel()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"GeomSpring"</span>, <span class="va">Geom</span>,</span>
<span>  </span>
<span>  <span class="co"># Asegúrese de que cada fila tenga una identificación de grupo única</span></span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Transforma los datos dentro del método draw_panel()</span></span>
<span>  draw_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                        <span class="va">panel_params</span>, </span>
<span>                        <span class="va">coord</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">linemitre</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Transforme los datos de entrada para especificar las rutas del resorte.</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Utilice el método draw_panel() de GeomPath para hacer el dibujo</span></span>
<span>    <span class="va">GeomPath</span><span class="op">$</span><span class="fu">draw_panel</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">springs</span>, </span>
<span>      panel_params <span class="op">=</span> <span class="va">panel_params</span>, </span>
<span>      coord <span class="op">=</span> <span class="va">coord</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      linemitre <span class="op">=</span> <span class="va">linemitre</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Especificar la estética predeterminada y requerida</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  default_aes <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    linetype <span class="op">=</span> <span class="fl">1L</span>, </span>
<span>    alpha <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    diameter <span class="op">=</span> <span class="fl">1</span>, </span>
<span>    tension <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A pesar de la extensión de este código, la mayor parte resulta familiar:</p>
<ul>
<li><p>Los métodos <code>setup_data()</code> son esencialmente los mismos: en ambos casos garantizan que cada fila de los datos de entrada tenga un identificador de grupo único.</p></li>
<li><p>El método <code>draw_panel()</code> para nuestro objeto <code>GeomSpring</code> es muy similar al método <code>compute_panel()</code>. La principal diferencia es que nuestro método <code>draw_panel()</code> tiene un paso adicional: pasa las coordenadas del resorte calculadas a <code>GeomPath$draw_panel()</code>. Debido a que los manantiales son simplemente caminos elegantes, el método <code>GeomPath$draw_panel()</code> funciona perfectamente bien aquí.</p></li>
<li><p>A diferencia del código <code>StatSpring</code> que escribimos anteriormente, el código <code>GeomSpring</code> usa el campo <code>default_aes</code> para proporcionar valores predeterminados para cualquier estética que el usuario no especifique.</p></li>
</ul>
<p>Un aspecto de este código puede sorprender a los desarrolladores que están acostumbrados al diseño orientado a objetos en otros lenguajes. Llamar directamente al método de un objeto afín, como lo hacemos cuando invocamos <code>GeomPath$draw_panel()</code> desde <code>GeomSpring$draw_panel()</code>, no se considera una buena práctica en otros sistemas orientados a objetos. Sin embargo, debido a que los objetos ggproto no tienen estado (<a href="internals.html#sec-ggproto-style" class="quarto-xref"><span>Sección 19.4.5</span></a>), esto es exactamente tan seguro como subclasificar <code>GeomPath</code> y llamar al método principal. Puede ver este enfoque en todas partes del código fuente de ggplot2.</p>
</section><section id="un-constructor" class="level3" data-number="21.4.3"><h3 data-number="21.4.3" class="anchored" data-anchor-id="un-constructor">
<span class="header-section-number">21.4.3</span> un constructor</h3>
<p>Al igual que en nuestros intentos anteriores, el paso final es escribir una función constructora <code>geom_spring()</code>. El código no es muy diferente a las versiones anteriores: usamos <code>GeomSpring</code> en lugar de <code>GeomPath</code>, y usamos la estadística de identidad en lugar de <code>StatSpring</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomSpring</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="probando-la-geom" class="level3" data-number="21.4.4"><h3 data-number="21.4.4" class="anchored" data-anchor-id="probando-la-geom">
<span class="header-section-number">21.4.4</span> Probando la geom</h3>
<p>Ahora tenemos una geom adecuada con una estética predeterminada funcional y la capacidad de establecer la estética como parámetros:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tension <span class="op">=</span> <span class="va">tension</span>, diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span>diameter <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="ext-springs_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="1200"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="ext-springs_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid" width="1200"></p>
</div>
</div>
</div>
<p>Todavía tiene algunas limitaciones, porque las unidades de <code>diameter</code> y <code>tension</code> se expresan en relación con la escala de los datos sin procesar. El diámetro real de un resorte con <code>diameter = 0.5</code> será diferente dependiendo de los límites del eje, y si los ejes x e y no están en la misma escala, la forma del resorte se distorsionará. Puedes ver esto en el siguiente ejemplo:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="fl">3</span>, yend <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>El mismo problema subyacente significa que el diámetro del resorte se expresa en el espacio de coordenadas. Esto hace que sea difícil definir un valor predeterminado significativo porque el tamaño absoluto del diámetro del resorte cambia cuando cambia la escala de los datos:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="fl">100</span>, yend <span class="op">=</span> <span class="fl">80</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Abordaremos este problema en <a href="#sec-spring4" class="quarto-xref"><span>Sección 21.6</span></a>.</p>
</section><section id="post-mortem-2" class="level3" data-number="21.4.5"><h3 data-number="21.4.5" class="anchored" data-anchor-id="post-mortem-2">
<span class="header-section-number">21.4.5</span> Post mortem</h3>
<p>En esta sección finalmente creamos nuestra propia extensión <code>Geom</code>. Esta suele ser la conclusión natural del desarrollo de una nueva capa, pero no siempre. A veces encontrarás que el enfoque <code>Stat</code> funciona perfectamente para tus propósitos y tiene la ventaja de que puedes usar la estadística con múltiples geoms. La elección final depende de usted como desarrollador y debe guiarse por cómo espera que la gente use la capa.</p>
<p>Quizás sea sorprendente que aún no hayamos hablado sobre lo que sucede dentro de los métodos <code>draw_*()</code>. Nuestro objeto <code>GeomSpring</code> se basa en el método <code>draw_panel()</code> de <code>GeomPath</code> para realizar el trabajo de crear la salida gráfica. Esto es bastante común. Por ejemplo, incluso el relativamente complejo <a href="https://github.com/tidyverse/ggplot2/blob/master/R/geom-boxplot.r"><code>GeomBoxplot</code></a> simplemente usa los métodos de dibujo de <code>GeomPoint()</code>, <code>GeomSegment</code> y <code>GeomCrossbar</code>.</p>
<p>Si necesita profundizar más, necesitará aprender un poco sobre la cuadrícula. La creación de grid grobs es una técnica avanzada, necesaria para relativamente pocas geoms. Pero crear un grob de cuadrícula le brinda el poder de usar unidades absolutas para el diámetro (por ejemplo, 1 cm) y ajustar la visualización del geom según el tamaño del dispositivo de salida. Nos ocuparemos de eso a continuación.</p>
</section></section><section id="una-introducción-a-la-cuadrícula" class="level2" data-number="21.5"><h2 data-number="21.5" class="anchored" data-anchor-id="una-introducción-a-la-cuadrícula">
<span class="header-section-number">21.5</span> Una introducción a la cuadrícula</h2>
<p>El paquete grid proporciona el sistema de gráficos subyacente sobre el que se construye ggplot2. Es uno de los dos sistemas de dibujo bastante diferentes que se incluyen en base R: gráficos base y cuadrícula. Los gráficos básicos tienen un modelo imperativo de “lápiz sobre papel”: cada función dibuja inmediatamente algo en el dispositivo gráfico. Al igual que el propio ggplot2, grid adopta un enfoque más declarativo en el que se construye una descripción del gráfico como un objeto, que luego se representa. Este enfoque declarativo nos permite crear objetos que existen independientemente del dispositivo gráfico y que pueden transmitirse, analizarse y modificarse. Es importante destacar que partes de un objeto gráfico pueden hacer referencia a otras partes, lo que le permite hacer cosas como definir este rectángulo para que tenga un ancho igual a la longitud de esa cadena de texto, etc.</p>
<p>Como desarrollador de ggplot2, descubrirá que puede lograr mucho sin necesidad de interactuar directamente con la cuadrícula, pero hay situaciones en las que es imposible lograr lo que desea sin bajar al nivel de la cuadrícula. Las dos situaciones más comunes son:</p>
<ol type="1">
<li><p>Necesita crear objetos gráficos que estén ubicados correctamente en el sistema de coordenadas, pero donde alguna parte de su apariencia tenga un tamaño absoluto fijo. En nuestro caso, este sería el resorte yendo correctamente entre dos puntos en el gráfico, pero el diámetro definido en cm en lugar de en relación con el sistema de coordenadas.</p></li>
<li><p>Necesita objetos gráficos que se actualicen durante el cambio de tamaño. Esto podría, por ejemplo. ser la posición de etiquetas como en el paquete ggrepel o los geoms <code>geom_mark_*()</code> en ggforce.</p></li>
</ol>
<p>Una introducción completa a grid es mucho más de lo que podemos cubrir en este libro, pero para ayudarlo a comenzar, le brindaremos el vocabulario mínimo absoluto para comprender cómo ggplot2 usa grid. Presentaremos conceptos básicos como grobs, ventanas gráficas, parámetros gráficos y unidades, pero lea <em>R Graphics</em> de <span class="citation" data-cites="murrell:2018">Murrell (<a href="#ref-murrell:2018" role="doc-biblioref">2018</a>)</span> para obtener todos los detalles.</p>
<section id="grobs" class="level3" data-number="21.5.1"><h3 data-number="21.5.1" class="anchored" data-anchor-id="grobs">
<span class="header-section-number">21.5.1</span> Grobs</h3>
<p>Para entender cómo funciona grid, lo primero que debemos hablar son <strong>grobs</strong>. Grobs (<strong>objetos</strong>gr**aficos) son representaciones atómicas de elementos gráficos en una cuadrícula e incluyen tipos como puntos, líneas, círculos, rectángulos y texto. El paquete grid proporciona funciones como <code><a href="https://rdrr.io/r/grid/grid.points.html">pointsGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.lines.html">linesGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.rect.html">rectGrob()</a></code> y <code><a href="https://rdrr.io/r/grid/grid.text.html">textGrob()</a></code> que crean objetos gráficos sin dibujar nada en el dispositivo gráfico. Estas funciones están vectorizadas, lo que permite que un solo punto represente múltiples puntos, por ejemplo:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="va">circles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">circles</span></span>
<span><span class="co">#&gt; circle[GRID.circle.582]</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tenga en cuenta que este código no dibuja nada: es sólo una descripción de un conjunto de círculos. Para dibujarlo, primero llamamos a <code><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage()</a></code> para borrar el dispositivo gráfico actual y luego <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>grid también proporciona <code><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree()</a></code>, que construye objetos compuestos a partir de múltiples grobs atómicos. Aquí hay una ilustración:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>  label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"small"</span>, <span class="st">"medium"</span>, <span class="st">"large"</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">composite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>También es posible definir sus propios grobs. Puede definir una nueva clase grob primitiva usando <code><a href="https://rdrr.io/r/grid/grid.grob.html">grob()</a></code> o una nueva clase compuesta usando <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>, luego especificar un comportamiento especial para su nueva clase. Veremos un ejemplo de esto en un momento.</p>
</section><section id="ventanas-gráficas" class="level3" data-number="21.5.2"><h3 data-number="21.5.2" class="anchored" data-anchor-id="ventanas-gráficas">
<span class="header-section-number">21.5.2</span> Ventanas gráficas</h3>
<p>El segundo concepto clave en grid es la idea de una <strong>ventana gráfica</strong>. Una ventana gráfica es una región de trazado rectangular que proporciona su propio sistema de coordenadas para los objetos que se dibujan dentro de ella y también puede proporcionar una cuadrícula tabular en la que se pueden anidar otras ventanas gráficas. Un grob individual puede tener su propia ventana gráfica o, si no se proporciona ninguna, heredará una. Si bien no necesitaremos considerar las ventanas gráficas al construir el grob para nuestros resortes, son un concepto importante que impulsa gran parte del diseño de alto nivel de los gráficos ggplot2, por lo que los presentaremos aquí muy brevemente. En el siguiente ejemplo usamos <code><a href="https://rdrr.io/r/grid/viewport.html">viewport()</a></code> para definir dos ventanas gráficas diferentes, una con parámetros predeterminados y la segunda que gira alrededor del punto medio 15 grados:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vp_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vp_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta vez, cuando creemos nuestros grobs compuestos, los asignaremos explícitamente a ventanas gráficas específicas estableciendo el argumento <code>vp</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">composite_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_default</span><span class="op">)</span></span>
<span><span class="va">composite_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_rotated</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cuando trazamos estos dos grobs, podemos ver el efecto de la ventana gráfica: aunque <code>composite_default</code> y <code>composite_rotated</code> se componen de los mismos dos grobs primitivos (es decir, <code>circles</code> y <code>labels</code>), pertenecen a ventanas gráficas diferentes, por lo que se ven diferentes cuando se dibuja la gráfica:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite_default</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite_rotated</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>ggplot2 genera automáticamente la mayoría de las ventanas gráficas que necesitará para trazar, pero es importante comprender la idea básica.</p>
</section><section id="parámetros-gráficos" class="level3" data-number="21.5.3"><h3 data-number="21.5.3" class="anchored" data-anchor-id="parámetros-gráficos">
<span class="header-section-number">21.5.3</span> Parámetros gráficos</h3>
<p>El siguiente concepto que debemos comprender es la idea de <strong>parámetros gráficos</strong>. Cuando definimos los grobs <code>circles</code> y <code>labels</code>, solo especificamos algunas de sus propiedades. Por ejemplo, no dijimos nada sobre el color o la transparencia, por lo que todas estas propiedades están configuradas en sus valores predeterminados. La función <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code> en grid le permite especificar parámetros gráficos como objetos distintos:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gp_blue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">gp_orange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Los objetos <code>gp_blue</code> y <code>gp_orange</code> proporcionan listas de configuraciones gráficas que ahora se pueden aplicar a cualquier grob que queramos usando el argumento <code>gp</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grob1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_default</span>, gp <span class="op">=</span> <span class="va">gp_blue</span><span class="op">)</span></span>
<span><span class="va">grob2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_rotated</span>, gp <span class="op">=</span> <span class="va">gp_orange</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cuando trazamos estos dos grobs, heredan la configuración proporcionada por los parámetros gráficos así como las ventanas gráficas a las que están asignados:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob2</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="unidades" class="level3" data-number="21.5.4"><h3 data-number="21.5.4" class="anchored" data-anchor-id="unidades">
<span class="header-section-number">21.5.4</span> Unidades</h3>
<p>El último concepto central que debemos discutir es el sistema de <strong>unidades</strong>. El paquete grid le permite especificar las posiciones (por ejemplo, <code>x</code> e <code>y</code>) y las dimensiones (por ejemplo, <code>length</code> y <code>width</code>) de grobs y ventanas gráficas utilizando una especificación flexible. En el sistema de unidades de cuadrícula existen tres estilos de unidades cualitativamente diferentes:</p>
<ul>
<li>Unidades absolutas, p.e. centímetros, pulgadas y puntos se refieren a tamaños físicos.</li>
<li>Unidades relativas, p.&nbsp;<code>npc</code> que representa una proporción del tamaño de la ventana gráfica actual.</li>
<li>Unidades definidas por cadenas u otros grobs, p.e. <code>strwidth</code>, <code>grobwidth</code>.</li>
</ul>
<p>La función <code><a href="https://rdrr.io/r/grid/unit.html">unit()</a></code> es la función principal que utilizamos al especificar unidades: <code>unit(1, "cm")</code> es 1 centímetro, mientras que <code>unit(0.5, "npc")</code> es la mitad del tamaño de la ventana gráfica correspondiente. . El sistema de unidades admite operaciones aritméticas que sólo se resuelven en el momento del sorteo, lo que permite combinar diferentes tipos de unidades: <code>unidad(0.5, "npc") + unidad(1, "cm")</code> define un punto a un centímetro de a la derecha del centro de la ventana gráfica actual.</p>
</section><section id="construyendo-clases-grob" class="level3" data-number="21.5.5"><h3 data-number="21.5.5" class="anchored" data-anchor-id="construyendo-clases-grob">
<span class="header-section-number">21.5.5</span> Construyendo clases grob</h3>
<p>Ahora que tenemos una comprensión básica de la cuadrícula, intentemos crear nuestra propia clase grob “sorpresa”: objetos que son círculos si miden menos de 3 cm, pero se transforman en cuadrados cuando miden más de 3 cm. Este no es el tipo de objeto gráfico más útil, pero es útil para ilustrar la flexibilidad del sistema de cuadrícula. El primer paso es escribir nuestra propia función constructora usando <code><a href="https://rdrr.io/r/grid/grid.grob.html">grob()</a></code> o <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>, dependiendo de si estamos creando un objeto primitivo o compuesto. Comenzamos creando una función constructora “delgada”:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surpriseGrob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                         <span class="va">y</span>, </span>
<span>                         <span class="va">size</span>, </span>
<span>                         <span class="va">default.units</span> <span class="op">=</span> <span class="st">"npc"</span>, </span>
<span>                         <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                         <span class="va">gp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                         <span class="va">vp</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Asegúrese de que los argumentos de entrada sean unidades</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Construya la subclase grob sorpresa como un gTree</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    size <span class="op">=</span> <span class="va">size</span>, </span>
<span>    name <span class="op">=</span> <span class="va">name</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">gp</span>, </span>
<span>    vp <span class="op">=</span> <span class="va">vp</span>, </span>
<span>    cl <span class="op">=</span> <span class="st">"surprise"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta función no hace mucho. Todo lo que hace es garantizar que los argumentos <code>x</code>, <code>y</code> y <code>size</code> sean unidades de cuadrícula y establece que el nombre de la clase sea “sorpresa”. Para definir el comportamiento de nuestro grob, necesitamos especificar métodos para una o ambas funciones genéricas <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContext()</a></code> y <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code>:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/grid/makeContent.html">makeContext()</a></code> se llama cuando se representa el grob principal y le permite controlar la ventana gráfica del grob. No necesitaremos usar eso para nuestra sorpresa.</p></li>
<li><p><code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> se llama cada vez que se cambia el tamaño de la región de dibujo y le permite personalizar el aspecto del grob según el tamaño u otro aspecto.</p></li>
</ul>
<p>Debido a que estas funciones genéricas utilizan el sistema de programación orientada a objetos S3, podemos definir nuestro método simplemente agregando el nombre de la clase al final del nombre de la función. Es decir, el método <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> para nuestro grob sorpresa se define creando una función llamada <code>makeContent.surprise()</code> que toma un grob como entrada y devuelve un grob modificado como salida:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">makeContent.surprise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x_pos</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">x</span></span>
<span>  <span class="va">y_pos</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">size</span>, unitTo <span class="op">=</span> <span class="st">"cm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Averigua si los tamaños dados son mayores o menores de 3 cm.</span></span>
<span>  <span class="va">circles</span> <span class="op">&lt;-</span> <span class="va">size</span> <span class="op">&lt;</span> <span class="fl">3</span></span>
<span>  </span>
<span>  <span class="co"># Crea un círculo para los más pequeños.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">circle_grob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x_pos</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      y <span class="op">=</span> <span class="va">y_pos</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">circle_grob</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Crea un grob recto para los grandes.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="op">!</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">square_grob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">rectGrob</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x_pos</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      y <span class="op">=</span> <span class="va">y_pos</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">square_grob</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Agregue el círculo y rectifique grob como hijos de nuestro grob de entrada</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.add.html">setChildren</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gList</a></span><span class="op">(</span><span class="va">circle_grob</span>, <span class="va">square_grob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Algunas de las funciones que hemos llamado aquí son nuevas, pero todas reutilizan los conceptos centrales que analizamos anteriormente. Específicamente:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth()</a></code> se utiliza para convertir unidades de cuadrícula de un tipo a otro.</li>
<li>
<code><a href="https://rdrr.io/r/grid/grid.grob.html">gList()</a></code> crea una lista de grobs.</li>
<li>
<code><a href="https://rdrr.io/r/grid/grid.add.html">setChildren()</a></code> especifica los grobs que pertenecen a un grob compuesto de gTree.</li>
</ul>
<p>El efecto de esta función es garantizar que cada vez que se renderiza el grob se recalcule el tamaño absoluto de cada forma. Todas las formas menores de 3 cm se convierten en círculos y todas las formas mayores de 3 cm se convierten en cuadrados. Para ver cómo se desarrolla esto, llamemos a nuestra nueva función:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surprises</span> <span class="op">&lt;-</span> <span class="fu">surpriseGrob</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.45</span>, <span class="fl">0.75</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, </span>
<span>  size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El grob <code>surprises</code> contiene tres formas cuyas ubicaciones y tamaños se han especificado en relación con el tamaño de la ventana gráfica. En este momento no tenemos idea de cuáles de estas formas serán círculos y cuáles serán cuadrados: eso depende del tamaño de la ventana gráfica en la que se dibujará el grob <code>surprises</code>. Ahora podemos dibujar el grob de la forma habitual:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">surprises</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Si ejecuta este código de forma interactiva y cambia el tamaño de la ventana de trazado, verá que los tres objetos cambian de forma según el tamaño de la ventana de trazado. Esta no es la forma más útil de emplear grid, por supuesto, pero esperamos que puedas ver cómo se puede utilizar esta técnica para realizar un trabajo real.</p>
</section><section id="sec-tabular-grid" class="level3" data-number="21.5.6"><h3 data-number="21.5.6" class="anchored" data-anchor-id="sec-tabular-grid">
<span class="header-section-number">21.5.6</span> Cuadrícula tabular</h3>
<p>El último aspecto de grid que discutiremos aquí es el motor de diseño proporcionado por el paquete gtable. No es necesario saber acerca de gtable para construir nuestro spring grob, pero hay otros tipos de extensiones ggplot2 que sí requieren este conocimiento, por lo que brindaremos una breve descripción aquí.</p>
<p>Como se discutió en <a href="internals.html#sec-ggplotgtable" class="quarto-xref"><span>Sección 19.3</span></a>, cuando ggplot2 pasa el gráfico a la cuadrícula para renderizarlo, lo hace creando un objeto gtable con <code>ggplot_gtable()</code>. Podemos extraer este objeto usando la función <code>ggplotGrob()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">displ</span>, <span class="va">hwy</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">grob_table</span> <span class="op">&lt;-</span> <span class="fu">ggplotGrob</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="va">grob_table</span></span>
<span><span class="co">#&gt; TableGrob (16 x 13) "layout": 22 grobs</span></span>
<span><span class="co">#&gt;     z         cells             name</span></span>
<span><span class="co">#&gt; 1   0 ( 1-16, 1-13)       background</span></span>
<span><span class="co">#&gt; 2   5 ( 8- 8, 6- 6)           spacer</span></span>
<span><span class="co">#&gt; 3   7 ( 9- 9, 6- 6)           axis-l</span></span>
<span><span class="co">#&gt; 4   3 (10-10, 6- 6)           spacer</span></span>
<span><span class="co">#&gt; 5   6 ( 8- 8, 7- 7)           axis-t</span></span>
<span><span class="co">#&gt; 6   1 ( 9- 9, 7- 7)            panel</span></span>
<span><span class="co">#&gt; 7   9 (10-10, 7- 7)           axis-b</span></span>
<span><span class="co">#&gt; 8   4 ( 8- 8, 8- 8)           spacer</span></span>
<span><span class="co">#&gt; 9   8 ( 9- 9, 8- 8)           axis-r</span></span>
<span><span class="co">#&gt; 10  2 (10-10, 8- 8)           spacer</span></span>
<span><span class="co">#&gt; 11 10 ( 7- 7, 7- 7)           xlab-t</span></span>
<span><span class="co">#&gt; 12 11 (11-11, 7- 7)           xlab-b</span></span>
<span><span class="co">#&gt; 13 12 ( 9- 9, 5- 5)           ylab-l</span></span>
<span><span class="co">#&gt; 14 13 ( 9- 9, 9- 9)           ylab-r</span></span>
<span><span class="co">#&gt; 15 14 ( 9- 9,11-11)  guide-box-right</span></span>
<span><span class="co">#&gt; 16 15 ( 9- 9, 3- 3)   guide-box-left</span></span>
<span><span class="co">#&gt; 17 16 (13-13, 7- 7) guide-box-bottom</span></span>
<span><span class="co">#&gt; 18 17 ( 5- 5, 7- 7)    guide-box-top</span></span>
<span><span class="co">#&gt; 19 18 ( 9- 9, 7- 7) guide-box-inside</span></span>
<span><span class="co">#&gt; 20 19 ( 4- 4, 7- 7)         subtitle</span></span>
<span><span class="co">#&gt; 21 20 ( 3- 3, 7- 7)            title</span></span>
<span><span class="co">#&gt; 22 21 (14-14, 7- 7)          caption</span></span>
<span><span class="co">#&gt;                                             grob</span></span>
<span><span class="co">#&gt; 1                rect[plot.background..rect.629]</span></span>
<span><span class="co">#&gt; 2                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 3            absoluteGrob[GRID.absoluteGrob.618]</span></span>
<span><span class="co">#&gt; 4                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 5                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 6                       gTree[panel-1.gTree.610]</span></span>
<span><span class="co">#&gt; 7            absoluteGrob[GRID.absoluteGrob.614]</span></span>
<span><span class="co">#&gt; 8                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 9                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 10                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 11                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 12 titleGrob[axis.title.x.bottom..titleGrob.621]</span></span>
<span><span class="co">#&gt; 13   titleGrob[axis.title.y.left..titleGrob.624]</span></span>
<span><span class="co">#&gt; 14                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 15                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 16                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 17                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 18                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 19                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 20         zeroGrob[plot.subtitle..zeroGrob.626]</span></span>
<span><span class="co">#&gt; 21            zeroGrob[plot.title..zeroGrob.625]</span></span>
<span><span class="co">#&gt; 22          zeroGrob[plot.caption..zeroGrob.627]</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El resultado ilustra cómo está estructurado el diseño de ggplot2. La gráfica se compone de 18 grobs distintos que están organizados en un <code>TableGrob</code> que especifica una cuadrícula de 12 x 9, que a su vez proporciona una colección de ventanas gráficas dentro de las cuales se pueden dibujar grobs individuales. Este <code>TableGrob</code> es en sí mismo un grobtree y se puede representar con grid llamando <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob_table</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Para ilustrar cómo funciona <code>TableGrob</code>, crearemos una versión simplificada de este resultado sin usar ggplot2. Nuestro primer paso es definir los grobs constituyentes que componen nuestra gráfica:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">xtick</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="va">ytick</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.points.html">pointsGrob</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">mpg</span><span class="op">$</span><span class="va">displ</span> <span class="op">/</span> <span class="va">xtick</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xtick</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  y <span class="op">=</span> <span class="va">mpg</span><span class="op">$</span><span class="va">hwy</span> <span class="op">/</span> <span class="va">ytick</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ytick</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  default.units <span class="op">=</span> <span class="st">'npc'</span>,</span>
<span>  size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">6</span>, <span class="st">'pt'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">xaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.xaxis.html">xaxisGrob</a></span><span class="op">(</span></span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xtick</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  label <span class="op">=</span> <span class="va">xtick</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">yaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.yaxis.html">yaxisGrob</a></span><span class="op">(</span></span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ytick</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  label <span class="op">=</span> <span class="va">ytick</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El grob <code>points</code> contiene los datos que se van a trazar, mientras que <code>xaxis</code> y <code>yaxis</code> son grobs que dibujan ejes etiquetados. Cuando dibujamos el grob de <code>points</code>, obtenemos el núcleo de un diagrama de dispersión:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Sin embargo, si queremos agregar ejes a este gráfico, necesitamos un conjunto de ventanas gráficas dispuestas en formato tabular para que podamos colocar el <code>xaxis</code> inmediatamente debajo de los <code>points</code> y el <code>yaxis</code> a la izquierda de los <code>points</code>. En ggplot2, esto lo maneja el motor de diseño gtable. Primero, usamos <code><a href="https://gtable.r-lib.org/reference/gtable.html">gtable()</a></code> para definir la estructura:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gtable.r-lib.org">gtable</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gtable.r-lib.org/reference/gtable.html">gtable</a></span><span class="op">(</span></span>
<span>  widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cm'</span>, <span class="st">'cm'</span>, <span class="st">'null'</span>, <span class="st">'cm'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cm'</span>, <span class="st">'null'</span>, <span class="st">'cm'</span>, <span class="st">'cm'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El objeto <code>plot_layout</code> es un <code>TableGrob</code> de 4 x 4 que define ventanas gráficas con tamaños que coinciden con las alturas de filas y los anchos de columna que pasamos a <code><a href="https://gtable.r-lib.org/reference/gtable.html">gtable()</a></code>. La función <code><a href="https://gtable.r-lib.org/reference/gtable_show_layout.html">gtable_show_layout()</a></code> proporciona una manera conveniente de visualizar este diseño:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://gtable.r-lib.org/reference/gtable_show_layout.html">gtable_show_layout</a></span><span class="op">(</span><span class="va">plot_layout</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Observe que este diseño tiene una fila con altura cero y una columna con ancho cero. Colocaremos los grobs <code>xaxis</code> y <code>yaxis</code> en estas filas y les permitiremos “desbordarse” en las filas y columnas adyacentes que especifican los márgenes del gráfico.</p>
<p>Para colocar los grobs en la mesa, usamos la función <code><a href="https://gtable.r-lib.org/reference/gtable_add_grob.html">gtable_add_grob()</a></code>. Un diseño <code>TableGrob</code> permite que un grob individual abarque varias celdas usando los argumentos <code>t</code>, <code>l</code>, <code>b</code> y <code>r</code> para especificar índices de celda para las celdas que están más arriba, más a la izquierda, más al fondo y más a la derecha abarcadas por el grob. Sin embargo, el valor predeterminado es asumir que cada grob pertenece exactamente a una celda, en cuyo caso solo es necesario especificar los argumentos <code>t</code> y <code>l</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gtable.r-lib.org/reference/gtable_add_grob.html">gtable_add_grob</a></span><span class="op">(</span></span>
<span>  <span class="va">plot_layout</span>,</span>
<span>  grobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">xaxis</span>, <span class="va">yaxis</span><span class="op">)</span>,</span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co"># la fila que define la extensión superior de cada grob</span></span>
<span>  l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co"># la columna que define la extensión izquierda de cada grob</span></span>
<span>  clip <span class="op">=</span> <span class="st">'off'</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si inspeccionamos nuestro objeto <code>plot_layout</code>, vemos algo que tiene la misma estructura que el <code>TableGrob</code> producido por el código ggplot2 anterior:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_layout</span></span>
<span><span class="co">#&gt; TableGrob (4 x 4) "layout": 3 grobs</span></span>
<span><span class="co">#&gt;   z     cells   name                    grob</span></span>
<span><span class="co">#&gt; 1 1 (2-2,3-3) layout points[GRID.points.630]</span></span>
<span><span class="co">#&gt; 2 2 (3-3,3-3) layout   xaxis[GRID.xaxis.631]</span></span>
<span><span class="co">#&gt; 3 3 (2-2,2-2) layout   yaxis[GRID.yaxis.632]</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora podemos dibujar nuestra gráfica usando <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">plot_layout</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Claramente, todavía nos faltan muchos detalles importantes que serían necesarios en una gráfica real, pero esperamos que ahora esté claro cómo ggplot2 organiza una colección de grobs dentro de un diseño de gráfica estructurado.</p>
</section></section><section id="sec-spring4" class="level2" data-number="21.6"><h2 data-number="21.6" class="anchored" data-anchor-id="sec-spring4">
<span class="header-section-number">21.6</span> Parte 4: Un grid grob</h2>
<p>Volvamos al problema que nos ocupa. Armados con nuestro nuevo conocimiento del sistema de rejilla, podemos construir un resorte que especifique el diámetro en unidades absolutas.</p>
<section id="springgrob" class="level3" data-number="21.6.1"><h3 data-number="21.6.1" class="anchored" data-anchor-id="springgrob">
<span class="header-section-number">21.6.1</span> springGrob</h3>
<p>Comencemos definiendo la función <code>springGrob()</code>. Nuestra idea clave es que podemos escribir el código grob de una manera que impulse la acción de extracción del resorte hasta el nivel de la función <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code>. Al hacer esto, podemos asegurarnos de que el diámetro se calcule en el momento del dibujo utilizando unidades absolutas en lugar de definir el diámetro en relación con las coordenadas del trazado.</p>
<p>Comenzaremos creando nuestra función constructora. Los argumentos de esta función se basan en <code><a href="https://rdrr.io/r/grid/grid.segments.html">segmentsGrob()</a></code> ya que, en esencia, estamos dibujando segmentos modificados:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">springGrob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">diameter</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                       <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                       <span class="va">default.units</span> <span class="op">=</span> <span class="st">"npc"</span>, </span>
<span>                       <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                       <span class="va">gp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                       <span class="va">vp</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Utilice la unidad predeterminada si el usuario no especifica una</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span><span class="op">)</span> <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span> <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y0</span><span class="op">)</span><span class="op">)</span> <span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y0</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span><span class="op">)</span> <span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">diameter</span><span class="op">)</span><span class="op">)</span> <span class="va">diameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">diameter</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Devuelve un gTree de clase "spring"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span></span>
<span>    x0 <span class="op">=</span> <span class="va">x0</span>, </span>
<span>    y0 <span class="op">=</span> <span class="va">y0</span>, </span>
<span>    x1 <span class="op">=</span> <span class="va">x1</span>, </span>
<span>    y1 <span class="op">=</span> <span class="va">y1</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    n <span class="op">=</span> <span class="va">n</span>, </span>
<span>    name <span class="op">=</span> <span class="va">name</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">gp</span>, </span>
<span>    vp <span class="op">=</span> <span class="va">vp</span>, </span>
<span>    cl <span class="op">=</span> <span class="st">"spring"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Vemos que una vez más nuestro constructor es una envoltura muy delgada alrededor de <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>. No introduce ningún concepto nuevo: todo lo que hace es garantizar que los argumentos se conviertan a unidades si es necesario y luego devuelve un grob compuesto con clase “spring”. El trabajo de dibujar nuestro resorte ocurre en el método <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">makeContent.spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Convertir valores de posición y diámetro en unidades absolutas</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertX</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x0</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertX</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x1</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertY</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y0</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertY</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y1</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">diameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Deja la tensión y n intacta.</span></span>
<span>  <span class="va">tension</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">tension</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">n</span></span>
<span>  </span>
<span>  <span class="co"># Transforme los datos de entrada en un marco de datos que contenga rutas de primavera</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>      <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">x0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        y <span class="op">=</span> <span class="va">y0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        xend <span class="op">=</span> <span class="va">x1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        yend <span class="op">=</span> <span class="va">y1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        tension <span class="op">=</span> <span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        n <span class="op">=</span> <span class="va">n</span></span>
<span>      <span class="op">)</span>,</span>
<span>      id <span class="op">=</span> <span class="va">i</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Construir el grob</span></span>
<span>  <span class="va">spring_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">polylineGrob</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">y</span>, </span>
<span>    id <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">id</span>, </span>
<span>    default.units <span class="op">=</span> <span class="st">"mm"</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">gp</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.add.html">setChildren</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gList</a></span><span class="op">(</span><span class="va">spring_paths</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nuevamente hay un par de nuevas funciones de cuadrícula aquí, pero esperamos que no sea demasiado difícil descubrir qué hacen. La verdad es que aquí no pasa nada especial. Cada vez que se cambia el tamaño del gráfico, tomamos las coordenadas y la configuración del diámetro del resorte y los convertimos todos a milímetros. Sólo después de convertir las cantidades importantes a unidades absolutas construimos las rutas de resorte usando la función <code>create_spring()</code> que escribimos al principio: al llevar la llamada a <code>create_spring()</code> a este nivel, podemos asegurarnos de que la ruta sea definido usando unidades absolutas y luego devuelve el resultado como un grob de polilínea.</p>
<p>Ahora tenemos un spring grob adecuado para usar en ggplot2. En la siguiente sección construiremos una geom a su alrededor, pero antes de hacerlo, verifiquemos que nuestro código se comporte como se esperaba:</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu">springGrob</span><span class="op">(</span></span>
<span>  x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  y1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>  tension <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">springs</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Esto se ve bien, por lo que ahora podemos diseñar nuestra nueva (y final) geom.</p>
</section><section id="el-último-geomspring" class="level3" data-number="21.6.2"><h3 data-number="21.6.2" class="anchored" data-anchor-id="el-último-geomspring">
<span class="header-section-number">21.6.2</span> El último GeomSpring</h3>
<p>Ahora que tenemos un grob personalizado que dibuja resortes, podemos crear un objeto ggproto <code>GeomSpring</code> que lo use. Aquí está el código completo para esa geom:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"GeomSpring"</span>, <span class="va">Geom</span>,</span>
<span>  </span>
<span>  <span class="co"># Compruebe que el usuario haya especificado parámetros sensibles                    </span></span>
<span>  setup_params <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Springs must be defined with `n` greater than 0"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">params</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Verifique los datos de entrada y devuelva grobs</span></span>
<span>  draw_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                        <span class="va">panel_params</span>, </span>
<span>                        <span class="va">coord</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Elimine los datos faltantes y regrese temprano si faltan todos</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">remove_missing</span><span class="op">(</span></span>
<span>      df <span class="op">=</span> <span class="va">data</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>,</span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span>, <span class="st">"linetype"</span>, <span class="st">"linewidth"</span><span class="op">)</span>,</span>
<span>      name <span class="op">=</span> <span class="st">"geom_spring"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">zeroGrob</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Proporcionar el sistema de coordenadas para la gráfica.</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">coord</span><span class="op">$</span><span class="fu">is_linear</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">warn</a></span><span class="op">(</span></span>
<span>        <span class="st">"spring geom only works correctly on linear coordinate systems"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">coord</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="va">data</span>, <span class="va">panel_params</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Construir el grob</span></span>
<span>    <span class="fu">springGrob</span><span class="op">(</span></span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">x</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">y</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">xend</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">yend</span>,</span>
<span>      default.units <span class="op">=</span> <span class="st">"native"</span>, </span>
<span>      diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">coord</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      tension <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">tension</span>, </span>
<span>      n <span class="op">=</span> <span class="va">n</span>,</span>
<span>      gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span></span>
<span>        col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">coord</span><span class="op">$</span><span class="va">colour</span>, <span class="va">coord</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>        lwd <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">linewidth</span> <span class="op">*</span> <span class="va">.pt</span>,</span>
<span>        lty <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">linetype</span>,</span>
<span>        lineend <span class="op">=</span> <span class="va">lineend</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Especificar la estética predeterminada y requerida</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  default_aes <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    linetype <span class="op">=</span> <span class="fl">1L</span>, </span>
<span>    alpha <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    diameter <span class="op">=</span> <span class="fl">0.35</span>, </span>
<span>    tension <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hay algunas cosas a tener en cuenta aquí. Como era de esperar, los principales cambios con respecto a la última versión se encuentran en el método <code>draw_panel()</code> (ver más abajo). Pero hay un par de cambios más.</p>
<ul>
<li><p>Las versiones anteriores de <code>GeomSpring</code>, y <code>StatSpring</code> anteriores, incluían un método <code>setup_data()</code> que modificaba la columna de grupo en los datos de entrada. Eso ya no existe: ya no necesitamos preocuparnos por esto porque esta nueva versión de geom no llama a <code>create_spring()</code> directamente. En lo que respecta a la geom, cada resorte está definido por una (y solo una) fila en los datos de entrada. Todo el trabajo de “expandir” esto a un camino similar a un resorte lo realiza grob.</p></li>
<li><p>Esta versión de <code>GeomSpring</code> tiene un método <code>setup_params()</code>. Su única función es comprobar el número de puntos utilizados para definir el resorte.</p></li>
<li><p>El campo <code>default_aes</code> es ligeramente diferente. El cambio importante es que ahora podemos establecer un valor predeterminado significativo para <code>diameter</code>.</p></li>
</ul>
<p>Ahora echemos un vistazo más de cerca al nuevo método <code>draw_panel()</code>. Debido a que ya no dependemos de <code>GeomPath$draw_panel()</code> para hacer el trabajo, tenemos algunas tareas nuevas de las que ocuparnos:</p>
<ul>
<li><p>Comprueba si el sistema de coordenadas no es lineal (por ejemplo, <code>coord_polar()</code>) y, de ser así, emite una advertencia porque nuestro resorte no está diseñado para funcionar en ese contexto.</p></li>
<li><p>Utiliza el sistema de coordenadas para reescalar la estética posicional llamando al método <code><a href="https://rdrr.io/r/base/transform.html">transform()</a></code> para el objeto <code>coord</code>. Esto reasigna toda la estética posicional para que se encuentre entre 0 y 1, siendo 0 el valor más bajo visible en nuestra ventana gráfica (expansiones de escala incluidas) y 1 el más alto. Con esta reasignación las coordenadas están listas para pasar al grob.</p></li>
<li><p>Pasamos un conjunto de parámetros gráficos al grob usando la función grid <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code>. No todos los grobs se preocupan por todas las entradas en <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code> y dado que estamos construyendo una línea, solo nos preocupamos por los parámetros gráficos que <code><a href="https://rdrr.io/r/grid/grid.lines.html">polylineGrob()</a></code> entiende, a saber: <code>col</code> (color de trazo), <code>lwd</code> (línea ancho), <code>lty</code> (tipo de línea), <code>lineend</code> (la forma del terminador de la línea).</p></li>
</ul>
<p>Ahora que <code>GeomSpring</code> está definido, todo lo que queda es crear una función constructora que el usuario pueda llamar:</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomSpring</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Por fin podemos darle un buen uso a nuestra nueva función <code>geom_spring()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">100</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Como puede ver en el resultado anterior, ahora tenemos resortes que se comportan de manera sensata cuando cambia la relación de aspecto de la gráfica o cuando los ejes xey están en diferentes escalas. Cambiar el tamaño del gráfico activará un nuevo cálculo de la ruta correcta, por lo que seguirá luciendo como debería.</p>
</section><section id="post-mortem-3" class="level3" data-number="21.6.3"><h3 data-number="21.6.3" class="anchored" data-anchor-id="post-mortem-3">
<span class="header-section-number">21.6.3</span> Post mortem</h3>
<p>Por fin hemos llegado a la geom de primavera que nos propusimos realizar. La estética del diámetro de nuestro resorte tiene un comportamiento similar a la estética del ancho de línea, en el sentido de que permanece fija al cambiar el tamaño y/o cambiar la relación de aspecto del gráfico. Todavía hay mejoras que podríamos (y quizás deberíamos) hacer. Lo más notable es que nuestra función <code>create_spring()</code> permanece sin vectorizar y debe llamarse para cada resorte por separado. Vectorizar correctamente esta función permitirá una aceleración considerable al renderizar muchos resortes (si alguna vez fuera necesario). Dejaremos esto como ejercicio para el lector.</p>
<p>Aunque la geom ya está terminada, todavía nos queda un poco de trabajo por hacer. Necesitamos crear una escala de diámetro y proporcionar claves de leyenda que puedan comunicar correctamente el diámetro y la tensión. Este será el tema de la sección final.</p>
</section></section><section id="sec-spring5" class="level2" data-number="21.7"><h2 data-number="21.7" class="anchored" data-anchor-id="sec-spring5">
<span class="header-section-number">21.7</span> Parte 5: Escalas</h2>
<p>El último paso de nuestro proceso es definir nuevas escalas. Queremos hacer esto porque hemos definido dos nuevas estéticas (diámetro y tensión) y nos gustaría que los usuarios pudieran escalarlas. No hay nada de malo en definir una nueva estética sin proporcionar una escala, lo que significa que los valores mapeados se pasan sin cambios, pero si queremos que los usuarios tengan cierto control y la posibilidad de una leyenda, necesitaremos proporcionar escalas. por la estetica. Este es el objetivo de esta sección final.</p>
<section id="escalada" class="level3" data-number="21.7.1"><h3 data-number="21.7.1" class="anchored" data-anchor-id="escalada">
<span class="header-section-number">21.7.1</span> Escalada</h3>
<p>Afortunadamente, en comparación con el trabajo que hemos realizado hasta ahora, crear nuevas escalas no es una tarea enorme. Discutimos las ideas básicas en <a href="extensions.html#sec-new-scales" class="quarto-xref"><span>Sección 20.5</span></a> y podemos aplicar esos conceptos aquí sin demasiado dolor. Nuestra tarea principal es crear una función con el nombre apropiado que genere un objeto <code>Scale</code>. La mayoría de las funciones de escala son simples envoltorios alrededor de una de las tres funciones constructoras de escala fundamentales, <code>continuous_scale()</code>, <code>discrete_scale()</code> y <code>binned_scale()</code>. Así es como lo hacemos para la estética de la tensión:</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension_continuous</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">continuous_scale</span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="st">"tension"</span>, </span>
<span>    scale_name <span class="op">=</span> <span class="st">"tension_c"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pal_rescale.html">rescale_pal</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span>, </span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta función <code>scale_tension_continuous()</code> indica a qué <code>aesthetics</code> se aplica, proporciona un <code>scale_name</code> explícito y proporciona una función <code>palette</code> que transforma el dominio de entrada al rango de salida. Todos los demás argumentos que normalmente esperaría ver en una función de escala, como <code>name</code>, <code>breaks</code>, <code>limits</code>, se pasan a <code>continuous_scale()</code> con los puntos <code>...</code>.<br>
Para la estética de la tensión, esperamos que los usuarios la apliquen sólo a escalas continuas, por lo que es conveniente definir <code>scale_tension()</code> como un alias para <code>scale_tension_continuous()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension</span> <span class="op">&lt;-</span> <span class="va">scale_tension_continuous</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finalmente, como no queremos que la gente intente mapear la estética de la tensión en datos discretos, también definiremos una función <code>scale_tension_discrete()</code> que siempre arroja un error:</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension_discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Tension cannot be used with discrete data"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La razón por la que esto funciona es que ggplot2 asigna la escala predeterminada para la estética buscando una función llamada <code>scale_&lt;aesthetic-name&gt;_&lt;data-type&gt;</code>, por lo que cada vez que el usuario asigna la tensión estética a una variable discreta, ggplot2 encontrará la función <code>scale_tension_discrete()</code> y arroja el error. Esta es también la razón por la que es importante incluir <code>scale_tension_continuous()</code> incluso cuando esperamos que la mayoría de los usuarios utilicen el alias <code>scale_tension()</code>.</p>
<p>Las funciones de escala para la estética del diámetro son sólo un poco más complicadas:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_diameter_continuous</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, </span>
<span>                                      <span class="va">range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>                                      <span class="va">unit</span> <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">range</span> <span class="op">&lt;-</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">range</span>, <span class="va">unit</span><span class="op">)</span>, </span>
<span>    <span class="st">"cm"</span>, </span>
<span>    valueOnly <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">continuous_scale</span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="st">"diameter"</span>, </span>
<span>    scale_name <span class="op">=</span> <span class="st">"diameter_c"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pal_rescale.html">rescale_pal</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span>, </span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">scale_diameter</span> <span class="op">&lt;-</span> <span class="va">scale_diameter_continuous</span></span>
<span><span class="va">scale_tension_discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Diameter cannot be used with discrete data"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El único cambio que hicimos con respecto a las escalas de <code>tension</code> es que permitimos al usuario definir en qué unidad se debe medir el rango de diámetro. Dado que el geom espera centímetros, convertiremos el rango a eso antes de pasarlo al constructor de escalas. De esa manera, el usuario es libre de utilizar cualquier unidad absoluta que le parezca natural.</p>
<p>Con nuestras escalas definidas, echemos un vistazo:</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Warning: The `scale_name` argument of `continuous_scale()` is deprecated as of ggplot2</span></span>
<span><span class="co">#&gt; 3.5.0.</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>En este resultado podemos ver que las escalas predeterminadas funcionan (es decir, no agregamos una escala explícita para el diámetro pero el gráfico se representa correctamente), al igual que las escalas personalizadas (es decir, llamamos explícitamente <code>scale_tension()</code>).</p>
<p>El resultado también nos dice que nuestro trabajo no ha terminado porque la leyenda no es muy útil. La razón de esto es que nuestra geom está utilizando el constructor de claves de leyenda predeterminado, <code>draw_key_point()</code>. Esta función no entiende nuestra nueva estética, por lo que la ignora por completo. Podemos solucionar este problema definiendo una función clave de leyenda personalizada, <code>draw_key_spring()</code>.</p>
</section><section id="draw_key_spring" class="level3" data-number="21.7.2"><h3 data-number="21.7.2" class="anchored" data-anchor-id="draw_key_spring">
<span class="header-section-number">21.7.2</span> draw_key_spring</h3>
<p>Echemos un vistazo a cómo se escribe un constructor de claves, inspeccionando el código fuente para <code>draw_key_point()</code>. Afortunadamente, estas son funciones bastante simples que toman un marco de datos de valores estéticos y devuelven un grob apropiado que proporciona las representaciones que se muestran en la clave de leyenda:</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draw_key_point</span></span>
<span><span class="co">#&gt; function(data, params, size) {</span></span>
<span><span class="co">#&gt;   if (is.null(data$shape)) {</span></span>
<span><span class="co">#&gt;     data$shape &lt;- 19</span></span>
<span><span class="co">#&gt;   } else if (is.character(data$shape)) {</span></span>
<span><span class="co">#&gt;     data$shape &lt;- translate_shape_string(data$shape)</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   # NULL means the default stroke size, and NA means no stroke.</span></span>
<span><span class="co">#&gt;   stroke_size &lt;- data$stroke %||% 0.5</span></span>
<span><span class="co">#&gt;   stroke_size[is.na(stroke_size)] &lt;- 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   pointsGrob(0.5, 0.5,</span></span>
<span><span class="co">#&gt;     pch = data$shape,</span></span>
<span><span class="co">#&gt;     gp = gpar(</span></span>
<span><span class="co">#&gt;       col = alpha(data$colour %||% "black", data$alpha),</span></span>
<span><span class="co">#&gt;       fill = fill_alpha(data$fill %||% "black", data$alpha),</span></span>
<span><span class="co">#&gt;       fontsize = (data$size %||% 1.5) * .pt + stroke_size * .stroke / 2,</span></span>
<span><span class="co">#&gt;       lwd = stroke_size * .stroke / 2</span></span>
<span><span class="co">#&gt;     )</span></span>
<span><span class="co">#&gt;   )</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5592fdd719c8&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:ggplot2&gt;</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En este código, <code>data</code> es un marco de datos con una sola fila que proporciona los valores estéticos que se utilizarán para la clave, <code>params</code> son los parámetros geográficos de la capa y <code>size</code> es el tamaño del área clave en centímetros. El operador <code>%||%</code>, que se ve a menudo en el código fuente de tidyverse, se usa para proporcionar valores predeterminados siempre que una variable tiene un valor nulo:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">`%||%`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="kw">else</span> <span class="va">x</span></span>
<span><span class="op">}</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para definir nuestra función <code>draw_key_spring()</code>, necesitamos crear una función análoga que use <code>springGrob()</code> para dibujar la clave:</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draw_key_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span>, <span class="va">size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">springGrob</span><span class="op">(</span></span>
<span>    x0 <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    y0 <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    x1 <span class="op">=</span> <span class="fl">1</span>, </span>
<span>    y1 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"cm"</span><span class="op">)</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">tension</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span></span>
<span>      col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">colour</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html">%||%</a></span> <span class="st">"black"</span>, <span class="va">data</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>      lwd <span class="op">=</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">size</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html">%||%</a></span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">*</span> <span class="va">.pt</span>,</span>
<span>      lty <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">linetype</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html">%||%</a></span> <span class="fl">1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"on"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La única parte de este código que puede resultar desconocida es la pequeña floritura (no estrictamente necesaria) que define una ventana gráfica de recorte para nuestro grob usando el argumento <code>vp</code>. La razón por la que agregamos esto es para garantizar que los resortes dibujados en las claves de leyenda estén estrictamente contenidos dentro de sus cajas y no se extiendan a las áreas clave vecinas.</p>
<p>Ahora que tenemos esta función, todo lo que tenemos que hacer es decirle a <code>GeomSpring</code> que la use al dibujar la clave de leyenda. Eso es bastante sencillo: todo lo que tenemos que hacer es cambiar el método <code>draw_key()</code> de nuestro Geom existente:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span><span class="op">$</span><span class="va">draw_key</span> <span class="op">&lt;-</span> <span class="va">draw_key_spring</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Con ese cambio final nuestra leyenda empieza a tener sentido:</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>El tamaño de clave predeterminado es un poco estrecho para nuestra clave, pero eso es algo que el usuario deberá hacer: ggplot2 no conoce la estética del <code>diameter</code> y no puede escalar el tamaño de la clave tan inteligentemente como lo hace con la estético <code>size</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Convenientemente, nuestra nueva clave de leyenda se utilizará para todas las estéticas escaladas, no solo para <code>diameter</code> y <code>tension</code>, asegurando así que el estilo de la clave siempre coincidirá con el estilo de la capa:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    colour <span class="op">=</span> <span class="va">class</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ext-springs_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="post-mortem-4" class="level3" data-number="21.7.3"><h3 data-number="21.7.3" class="anchored" data-anchor-id="post-mortem-4">
<span class="header-section-number">21.7.3</span> Post mortem</h3>
<p>Con esto concluye nuestro estudio de caso detallado sobre la creación de una geom de resorte. Con suerte, ha quedado claro que hay muchas formas diferentes de lograr la misma extensión de geom y que el resultado final depende en gran medida de tus necesidades y de la cantidad de energía que quieras ponerle. El estudio de caso se centró en capas y (en menor medida) escalas, pero con suerte puedes usar los ejemplos más simples de <a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a> como guía si deseas explorar otros tipos de extensiones de ggplot2. También puedes estudiar el código fuente de las clases faceta y coord en ggplot2 y las extensiones disponibles en ggforce y otros paquetes.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-murrell:2018" class="csl-entry" role="listitem">
Murrell, Paul. 2018. <em>R Graphics</em>. Third. Chapman &amp; Hall/CRC. <a href="https://www.stat.auckland.ac.nz/~paul/RG3e/">https://www.stat.auckland.ac.nz/~paul/RG3e/</a>.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Si tiene experiencia en estadística, reconocerá que esto es más o menos análogo a cómo se calcula una estadística z.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Si tiene experiencia en el desarrollo de paquetes, es posible que se pregunte acerca de la opción de usar <code><a href="https://rlang.r-lib.org/reference/abort.html">rlang::abort()</a></code> en lugar de usar la función base <code><a href="https://rdrr.io/r/base/stop.html">stop()</a></code>. Ciertamente podríamos haber elegido usar la función base R aquí, pero como ggplot2 usa el paquete rlang, en este caso hay muy poca diferencia.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Si planeáramos agrupar este código como un paquete R, podríamos ampliarlo y escribir pruebas unitarias formales para <code>create_spring()</code> usando el paquete testthat.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Por convención, las clases de ggproto siempre usan CamelCase para nombrar y la nueva clase siempre se guarda en una variable con el mismo nombre.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Como mencionamos anteriormente, ggproto no hace una fuerte distinción entre métodos y campos. Los objetos <code>Stat</code> esperan que <code>compute_group()</code> sea una función, por lo que nos referimos a <code>compute_group()</code> como método porque esa es la terminología estándar en la programación orientada a objetos. Por el contrario, <code>Stat</code> espera que <code>required_aes</code> sea una variable, por eso lo llamamos campo.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./extensions.html" class="pagination-link" aria-label="Extendiendo ggplot2">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extendiendo ggplot2</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>ggplot2: Gráficos elegantes para análisis de datos (3e) fue escrito por Hadley Wickham, Danielle Navarro, y Thomas Lin Pedersen.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>